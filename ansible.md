# Ansible

Ansible — это мощный инструмент для автоматизации конфигурации, управления серверами, развертывания приложений и многого другого. Он прост в использовании и не требует установки агентов на удаляемых хостах. Рассмотрим основные концепты Ansible:

1. Inventory (Инвентарь)

- Inventory — это файл (или группа файлов), который содержит список узлов (хостов), управляемых Ansible. Инвентарь может быть статическим (например, простой текстовый файл) или динамическим (генерируется скриптом).
- Пример статического инвентаря:

  ```
  [webservers]
  web1.example.com
  web2.example.com

  [databases]
  db1.example.com
  db2.example.com
  ```

- Можно также указать дополнительные переменные для конкретных хостов:

  ```
  [webservers]
  web1.example.com ansible_user=admin ansible_ssh_private_key_file=/path/to/key
  web2.example.com ansible_user=admin ansible_ssh_private_key_file=/path/to/key

  ```

2. Playbook

- Playbook — это сценарий автоматизации, написанный на YAML, который описывает последовательность задач (tasks) для выполнения на одном или нескольких хостах. Playbooks состоят из одного или более «play» — секций, в которых определяется, какие узлы будут затронуты и какие задачи необходимо выполнить.
- Пример простого playbook:

  ```
  # Файл site.yml
  - name: Установка и настройка веб-сервера
    hosts: webservers
    become: yes  # Включить выполнение задач с повышенными правами (sudo)
    tasks:
      - name: Установить Nginx
        apt:
          name: nginx
          state: present

      - name: Убедиться, что Nginx запущен
        service:
          name: nginx
          state: started
  ```

3. Tasks (Задачи)

- Задачи — это отдельные действия в playbook, которые Ansible должен выполнить на удаленном хосте. Каждая задача использует модуль Ansible для выполнения определенной операции, например, установки пакета, копирования файла или управления службой.
- Пример задачи:
  ```
  - name: Установить Nginx
    apt:
      name: nginx
      state: present
  ```

4. Modules (Модули)

- Модули — это инструменты, которые выполняют конкретные действия на удаленных хостах. Ansible предоставляет сотни встроенных модулей для управления всем, начиная от пакетов и пользователей до облачных ресурсов.
- Примеры модулей:
  - apt: управление пакетами на системах на основе Debian.
  - yum: управление пакетами на системах на основе Red Hat.
  - service: управление службами (запуск, остановка, перезапуск и т.д.).

5. Roles (Роли)

- Роли — это способ структурировать playbook, чтобы его можно было легко переиспользовать и поддерживать. Роль включает в себя задачи, переменные, файлы, шаблоны и обработчики, необходимые для выполнения определенной задачи.
- Пример структуры роли:
  ```
  my_role/
  ├── tasks/
  │   └── main.yml
  ├── handlers/
  │   └── main.yml
  ├── templates/
  │   └── config.j2
  ├── files/
  │   └── my_file.txt
  ├── vars/
  │   └── main.yml
  └── meta/
      └── main.yml
  ```
- Пример задачи внутри роли (tasks/main.yml):

```
- name: Установить Nginx
  apt:
    name: nginx
    state: present

- name: Скопировать конфигурационный файл Nginx
  template:
    src: nginx.conf.j2
    dest: /etc/nginx/nginx.conf
  notify: Перезапустить Nginx
```

6. Handlers (Обработчики)

- Обработчики — это особые задачи, которые выполняются только при вызове через notify в другой задаче. Обычно их используют для выполнения действий, которые зависят от изменений, внесенных предыдущими задачами, например, перезапуск сервиса после изменения конфигурационного файла.
- Пример обработчика:

  ```
  tasks:
  - name: Обновить конфигурацию Nginx
    template:
      src: nginx.conf.j2
      dest: /etc/nginx/nginx.conf
      notify:
      - Перезапустить Nginx

  handlers:
  - name: Перезапустить Nginx
    service:
      name: nginx
      state: restarted
  ```

7. Variables (Переменные)

- Переменные позволяют вам сделать ваши playbooks гибкими и настраиваемыми. Их можно определять в разных местах, таких как инвентарь, playbooks, роли, или даже передавать через командную строку.
- Пример использования переменных:

  ```
  - name: Установить веб-сервер
    hosts: webservers
    vars:
      http_port: 80
    tasks:
      - name: Обновить конфигурацию Nginx
      template:
          src: nginx.conf.j2
          dest: /etc/nginx/nginx.conf
      notify:
          - Перезапустить Nginx

  ```

- Пример шаблона с переменными (templates/nginx.conf.j2):
  ```
  server {
      listen {{ http_port }};
      server_name localhost;
      location / {
          root /var/www/html;
          index index.html;
      }
  }
  ```

8. Templates (Шаблоны)

- Шаблоны — это файлы, которые могут использовать переменные Ansible для генерации конфигурационных файлов на удаленных хостах. Ansible использует движок шаблонов Jinja2 для обработки шаблонов.
- Пример шаблона nginx.conf.j2:
  ```
  server {
      listen {{ http_port }};
      server_name localhost;
      location / {
          root /var/www/html;
          index index.html;
      }
  }
  ```

9. Facts (Факты)

- Факты — это автоматически собираемая информация об управляемых хостах, такая как IP-адреса, операционная система, установленное ПО и многое другое. Эта информация может использоваться в задачах и шаблонах.
- Пример использования фактов:
  ```
  - name: Показать операционную систему
    debug:
      msg: "OS: {{ ansible_facts['os_family'] }}"
  ```

10. Play (Игры)

- Play — это набор задач, которые выполняются на одной или нескольких группах хостов. Play определяет, какие хосты будут затронуты и какие переменные должны быть использованы.
- Пример игры:

```
- name: Настройка веб-серверов
  hosts: webservers
  tasks:
    - name: Установить и настроить Nginx
      include_role:
        name: nginx_role
```

11. Galaxy

- Ansible Galaxy — это репозиторий, где вы можете найти и загрузить предварительно созданные роли, созданные сообществом, или поделиться своими ролями.
- Команда для установки роли из Galaxy:

  ```
  ansible-galaxy install geerlingguy.nginx
  ```

12. Vault

- Ansible Vault — это инструмент для шифрования переменных и файлов, содержащих чувствительные данные, такие как пароли или ключи API.
- Пример создания зашифрованного файла:

```
ansible-vault create secrets.yml
```

- Пример использования зашифрованного файла в плейбуке:

```
- name: Использование секретов
  hosts: webservers
  vars_files:
    - secrets.yml
  tasks:
    - name: Показать секретное сообщение
      debug:
        msg: "{{ secret_message }}"

```

13. Tags (Теги)

- Теги позволяют вам выбирать определенные задачи или группы задач для выполнения. Это полезно, если вы хотите запустить только определенные части playbook.
- Пример использования тегов:

```
- name: Установить и настроить веб-сервер
  hosts: webservers
  tasks:
    - name: Установить Nginx
      yum:
        name: nginx
        state: present
      tags: установка

    - name: Запустить Nginx
      service:
        name: nginx
        state: started
      tags: запуск
```

- Запуск только задач с тегом установка:

```
ansible-playbook site.yml --tags "установка"
```

14. Callbacks (Обратные вызовы)

- Callback-плагины позволяют модифицировать вывод Ansible или отправлять его в сторонние системы. Например, можно отправить результаты выполнения playbook в систему мониторинга.
- Пример использования callback-плагина для отправки результатов в Slack:

```
- name: Настройка веб-серверов
  hosts: webservers
  tasks:
    - name: Установить Nginx
      apt:
        name: nginx
        state: present
      notify: Перезапустить Nginx

- name: Callback для отправки сообщений в Slack
  hosts: localhost
  tasks:
    - name: Отправить сообщение в Slack
      slack:
        token: "{{ slack_token }}"
        msg: "Настройка веб-серверов завершена."
        channel: "#alerts"
```

15. Loops (Циклы)

- Циклы позволяют повторять выполнение задачи несколько раз с различными входными данными. Ansible поддерживает различные типы циклов, такие как loop, with_items, with_dict, и т.д.
- Пример использования цикла:

```
tasks:
  - name: Установить список пакетов
    yum:
      name: "{{ item }}"
      state: present
    loop:
      - nginx
      - httpd
      - php
```
