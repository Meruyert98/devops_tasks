# Grafana

**Grafana** — это мощная система для мониторинга и визуализации данных, которая поддерживает различные источники данных, такие как Prometheus, Elasticsearch, MySQL, PostgreSQL и другие. Она широко используется для создания интерактивных дашбордов и графиков, отображающих метрики и логи из различных систем.

**1. Дашборды (Dashboards)**
Дашборд в Grafana — это набор визуализаций, которые отображают данные из одного или нескольких источников. Это основной элемент интерфейса, который позволяет пользователю отслеживать метрики и состояния систем в режиме реального времени.

- Пример:
  - Дашборд для мониторинга веб-приложения может включать:
    - График загруженности процессора.
    - Количество активных подключений к базе данных.
    - Среднее время ответа API.

**2. Панели (Panels)**
Панели — это индивидуальные визуализации внутри дашборда. Каждая панель может представлять данные в различных форматах, таких как графики, диаграммы, текст, карты, таблицы и др.

- Пример:
  Панель с графиком, показывающим использование CPU за последние 24 часа.

      - Источник данных: Prometheus.
      - Метрика: node_cpu_seconds_total.

      ```sql
      avg(rate(node_cpu_seconds_total[5m])) by (instance)
      ```

**3. Источники данных (Data Sources)**
Grafana поддерживает подключение к различным источникам данных. Это может быть база данных, система логов или сервис мониторинга (например, Prometheus, InfluxDB, Elasticsearch и др.).

Пример:
Подключение к Prometheus как к источнику данных: - URL: http://localhost:9090 - Название источника: Prometheus - Метрики: метрики, собранные Prometheus.

**4. Запросы (Queries)**
Запросы — это инструкции, которые определяют, какие данные будут визуализированы на панели. В зависимости от источника данных можно использовать различные языки запросов (например, PromQL для Prometheus, SQL для баз данных).

- Пример:
  Запрос для отображения средней загрузки процессора с использованием PromQL:
  `sql
avg(rate(node_cpu_seconds_total[5m])) by (instance)
`
  Этот запрос покажет среднюю загрузку процессора на каждом сервере за последние 5 минут.

**5. Алерты (Alerts)**
Grafana позволяет настраивать алерты на основе данных из панелей. Алерты срабатывают, когда значения метрик выходят за пределы определённых порогов. Уведомления могут быть отправлены через e-mail, Slack, Telegram, PagerDuty и другие интеграции.

- Пример:
  Алерт, который срабатывает, если загрузка CPU превышает 90% в течение 10 минут:
  ```sql
  # Условие для срабатывания алерта:
  expr: avg_over_time(node_cpu_seconds_total[10m]) > 0.9
  # Порог:
  threshold: 90
  ```
  Этот алерт может быть отправлен в Slack, чтобы предупредить команду об угрозе перегрузки системы.

**6. Пользовательские роли и доступ (User Roles and Permissions)**
Grafana предоставляет гибкую систему управления доступом, где можно назначать роли различным пользователям:

- Viewer — доступ только для просмотра дашбордов.
- Editor — возможность редактировать и создавать новые дашборды.
- Admin — полный доступ ко всем настройкам и данным.

- Пример:
  - Viewer может просматривать дашборд мониторинга сервера, но не может вносить изменения.
  - Editor может добавлять новые панели или изменять существующие графики.

**7. Плагины (Plugins)**
Grafana поддерживает плагины для расширения функциональности. С помощью плагинов можно добавлять новые типы панелей, источники данных, функции и визуализации.

- Пример плагинов:
  - Zabbix Plugin: для подключения к системе мониторинга Zabbix.
  - Pie Chart Plugin: добавляет возможность отображения данных в виде круговых диаграмм.

**8. Темплейты (Templating)**
Темплейты позволяют создавать динамические дашборды, которые могут изменять данные на основе выбранных переменных. Переменные могут быть параметрами (например, название сервера или базы данных), которые используются для изменения запросов и отображаемых данных на панелях.

- Пример:
  Создание переменной instance, которая представляет список серверов, и автоматическая подстройка графиков под выбранный сервер.

      - Переменная: instance
      - Запрос: label_values(node_cpu_seconds_total, instance)
      - Использование переменной в запросе:
          ```sql
          avg(rate(node_cpu_seconds_total{instance=~"$instance"}[5m]))
          ```
          Теперь можно выбирать сервер из выпадающего списка, и графики будут обновляться для выбранного сервера.

**9. Переменные (Variables)**
Переменные — это динамические параметры, которые позволяют пользователям изменять запросы и визуализации на дашбордах в зависимости от выбранных значений.

- Пример:
  Создание переменной для фильтрации по сервисам:

      - Переменная: service
      - Запрос для переменной (Prometheus):
          ```sql
          label_values(up, job)
          ```
      - Использование переменной:
          ```sql
          avg(rate(http_requests_total{job="$service"}[5m]))
          ```
      Теперь можно динамически выбирать сервис для просмотра количества запросов.

**10. Эксплорер (Explore)**
Explore — это инструмент для исследования данных в реальном времени, который помогает пользователям взаимодействовать с данными без необходимости создания постоянных дашбордов. В Explore можно выполнять запросы, исследовать логи и данные, проводить анализ.

- Пример использования:
  - Можно быстро выполнить запрос для поиска всех HTTP-запросов с кодом ошибки 500:
    ```sql
    http_requests_total{status="500"}
    ```
  - Исследовать логи из системы, подключённой к Elasticsearch, для поиска ошибок.

**11. Сниппеты (Annotations)**
Аннотации — это заметки, которые можно добавлять на графики для отображения важных событий или изменений в системе. Они помогают командам отслеживать ключевые моменты (например, развертывание новой версии приложения).

- Пример:
  Аннотация может быть добавлена на график производительности с меткой "Release v2.1", чтобы показать, как повлияло обновление приложения на систему.

**12. API Grafana**
Grafana предоставляет API для программного взаимодействия. Можно использовать API для автоматического создания дашбордов, изменения конфигурации источников данных и настройки алертов.

- Пример:
  Запрос через API для создания нового дашборда:
  ```bash
  curl -X POST http://localhost:3000/api/dashboards/db \
  -H "Content-Type: application/json" \
  -d '{
      "dashboard": {
      "id": null,
      "title": "New Dashboard",
      "panels": [],
      "version": 0
      },
      "folderId": 0,
      "overwrite": false
  }'
  ```

**Как работают все концепты вместе:**

- Источники данных (например, Prometheus) собирают метрики и передают их в Grafana.
- В панелях отображаются графики или таблицы с метриками.
- Алерты отправляют уведомления при превышении порогов (например, превышение нагрузки на CPU).
- Темплейты и переменные позволяют создавать динамические дашборды для разных серверов или сервисов.
- Плагины расширяют функциональность Grafana и позволяют интегрировать её с другими системами.
- Explore используется для быстрого анализа данных без создания постоянных дашбордов.
