# Jenkins

Jenkins — это популярный сервер автоматизации с открытым исходным кодом, широко используемый для непрерывной интеграции (CI) и непрерывной доставки (CD). Ниже приведены ключевые концепции Jenkins с примерами, которые помогут вам эффективно его использовать.

1. Pipeline (Конвейер)
   Pipeline — это набор плагинов, который поддерживает реализацию и интеграцию конвейеров непрерывной доставки в Jenkins. Конвейеры могут быть определены с использованием языка, известного как Jenkinsfile.

- Пример простого Jenkinsfile
  ```groovy
  pipeline {
      agent any
      stages {
          stage('Build') {
              steps {
                  echo 'Строим...'
              }
          }
          stage('Test') {
              steps {
                  echo 'Тестируем...'
              }
          }
          stage('Deploy') {
              steps {
                  echo 'Разворачиваем...'
              }
          }
      }
  }
  ```

2. Job (Задание)
   Job — это конкретная задача или набор задач, которые выполняет Jenkins, например, сборка кода, запуск тестов или развертывание приложений. Задания можно настраивать через графический интерфейс или определять в Jenkinsfile.

- Пример создания Freestyle Job
  - Перейдите в Jenkins Dashboard.
  - Нажмите New Item.
  - Выберите Freestyle project и дайте ему имя.
  - В разделе Build добавьте шаги сборки, например, выполнение команды shell.

3. Agent (Агент)
   Agent (или узел) — это машина, на которой выполняются задания Jenkins. Главный узел Jenkins управляет агентами и может распределять задания между ними в зависимости от доступности.

- Пример определения агента
  В Jenkinsfile вы можете указать, где выполнять ваш конвейер:
  `groovy
  pipeline {
      agent { label 'linux' }
      stages {
          stage('Build') {
              steps {
                  echo 'Строим на агенте Linux...'
              }
          }
      }
  }
  `

4. Plugins (Плагины)
   Jenkins имеет богатую экосистему плагинов, которые расширяют его функциональность. Плагины позволяют интегрироваться с различными инструментами и сервисами, такими как системы управления версиями, инструменты сборки и платформы развертывания.

- Пример установки плагина
  - Перейдите в Manage Jenkins > Manage Plugins.
  - На вкладке Available найдите нужный плагин (например, Git).
  - Установите галочку и нажмите Install without restart.

5. Build Triggers (Триггеры сборки)
   Триггеры сборки — это условия, которые запускают сборку. Общими триггерами являются опрос системы управления версиями (VCS) или ответ на вебхуки.

- Пример настройки опроса
  - В Freestyle job перейдите в раздел Build Triggers.
  - Установите галочку на Poll SCM и задайте расписание (например, H/5 \* \* \* \* для опроса каждые 5 минут).

6. Workspace (Рабочее пространство)
   Каждое задание в Jenkins имеет свое собственное рабочее пространство — каталог на агенте, где хранятся файлы задания. Оно содержит все файлы, необходимые для выполнения задания.

- Пример доступа к рабочему пространству
  В Jenkinsfile вы можете получить доступ к рабочему пространству следующим образом:
  `groovy
  pipeline {
      agent any
      stages {
          stage('Build') {
              steps {
                  sh 'ls -la'  // Список файлов в рабочем пространстве
              }
          }
      }
  }
  `

7. Environment Variables (Переменные окружения)
   Переменные окружения — это динамические значения, которые могут влиять на поведение процессов, работающих в заданиях Jenkins. Вы можете использовать предопределенные переменные или определять собственные.

- Пример использования переменных окружения
  ```groovy
  pipeline {
      agent any
      environment {
          MY_VAR = 'Привет, мир!'
      }
      stages {
          stage('Echo Variable') {
              steps {
                  echo "${MY_VAR}"
              }
          }
      }
  }
  ```

8. Post-build Actions (Действия после сборки)
   Действия после сборки позволяют указать, что должно произойти после завершения сборки. Это может включать уведомления, архивирование артефактов или запуск других заданий.

- Пример уведомления по электронной почте
  - В Freestyle job перейдите в Post-build Actions.
  - Выберите E-mail Notification.
  - Настройте получателей и условия, при которых нужно отправлять уведомления.

9. Declarative vs. Scripted Pipelines (Декларативные и скриптовые конвейеры)
   Существует два типа конвейеров в Jenkins:

- Декларативный конвейер: Упрощенный синтаксис для определения конвейеров со структурированным форматом.
- Скриптовый конвейер: Более гибкая структура, подобная коду, которая позволяет использовать сложную логику.
  Пример скриптового конвейера
  `groovy
  node {
      stage('Build') {
          echo 'Строим...'
      }
      stage('Test') {
          echo 'Тестируем...'
      }
      stage('Deploy') {
          echo 'Разворачиваем...'
      }
  }
  `

10. Jenkinsfile
    Jenkinsfile — это текстовый файл, который содержит определение конвейера Jenkins. Его можно хранить в репозитории исходного кода вместе с кодом приложения.

- Пример Jenkinsfile в репозитории Git
  Вы можете создать файл Jenkinsfile в вашем проекте:

      ```groovy
      pipeline {
          agent any
          stages {
              stage('Build') {
                  steps {
                      sh './gradlew build'
                  }
              }
              stage('Test') {
                  steps {
                      sh './gradlew test'
                  }
              }
              stage('Deploy') {
                  steps {
                      sh 'deploy.sh'
                  }
              }
          }
      }
      ```

11. Distributed Builds (Распределенные сборки)
    Jenkins может распределять сборки между несколькими узлами, что позволяет лучше использовать ресурсы и ускорять сборки.

- Пример добавления нового узла
  - Перейдите в Manage Jenkins > Manage Nodes and Clouds.
  - Нажмите New Node.
  - Укажите имя и выберите тип узла (например, Permanent Agent).
  - Настройте детали узла и метод запуска.

12. Parameters (Параметры)
    Параметры позволяют пользователям передавать значения в процесс сборки во время выполнения. Это полезно для настройки сборок на основе ввода пользователя.

- Пример добавления параметров к заданию
  В Freestyle job: - Перейдите в раздел General и установите галочку на This project is parameterized. - Добавьте параметры (например, String Parameter) с значением по умолчанию. - Используйте параметр в ваших шагах сборки как ${PARAMETER_NAME}.

13. Jenkins отправка уведомлений на телеграм канал

    ```groovy
    pipeline {
        agent any

        environment {
            TELEGRAM_BOT_TOKEN = 'ВАШ_ТОКЕН_БОТА'
            TELEGRAM_CHAT_ID = 'ВАШ_ID_ЧАТА'
            TELEGRAM_URL = "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage"
        }

        stages {
            stage('Build') {
                steps {
                    echo 'Строим проект...'
                    // Ваши команды сборки
                }
            }
            stage('Test') {
                steps {
                    echo 'Запускаем тесты...'
                    // Ваши команды тестирования
                }
            }
            stage('Deploy') {
                steps {
                    echo 'Разворачиваем проект...'
                    // Ваши команды развертывания
                }
            }
        }

        post {
            success {
                script {
                    def message = "✅ Сборка успешна: ${env.JOB_NAME} - ${env.BUILD_NUMBER}"
                    sh "curl -s -X POST ${TELEGRAM_URL} -d chat_id=${TELEGRAM_CHAT_ID} -d text='${message}'"
                }
            }
            failure {
                script {
                    def message = "❌ Сборка не удалась: ${env.JOB_NAME} - ${env.BUILD_NUMBER}"
                    sh "curl -s -X POST ${TELEGRAM_URL} -d chat_id=${TELEGRAM_CHAT_ID} -d text='${message}'"
                }
            }
        }
    }
    ```
